# 开发笔记

## 串口通信框架

### 总体分层

#### 设备：Device

用户侧接口：

- Open：启动 Daemon
- Close：关闭Daemon

- Write：阻塞式写入，将指针发给 Daemon
- Read：阻塞式读取，将指针发给 Daemon
- AsyncWrite：异步写入，增长写缓冲区，将内容复制到缓冲区，通知 Daemon 写入
- AsyncRead：异步读取，增长读缓冲区，通知 Daemon 读取
- WaitForWriting
- WaitForReading
- SetWriteCb
- SetReadCb

内部：

WriteBuffer

ReadBuffer

WriteQueueEmptyCb

ReadQueueEmptyCb

#### Daemon：实际读写驱动的线程

```cpp
struct IoTask {
    uint8_t *ptr;
    size_t len;
    std::function callback;
};

Queue<IoTask> write_queue;
Queue<IoTask> read_queue;

void WriteCb(IoTask task){
    write_lock.unlock();
    SendSignal();
	task.callback();
}

void ReadCb(IoTask task){
    read_lock.unlock();
    SendSignal();
    task.callback();
}

while(true){
    WaitForSignal();
    
    if(write_lock.is_available()){
        if(write_queue.empty()){
            if(LastTimeIsNotEmpty(write_queue)){
                WriteQueueEmptyCb();
            }
        }else{
            write_lock.lock();
            Driver.AsyncWrite(write_queue.pop());
        }
    }
    
    if(read_lock.is_available()){
        if(read_queue.empty()){
            if(LastTimeIsNotEmpty(read_queue)){
                ReadQueueEmptyCb();
            }
        }else{
            read_lock.lock();
            Driver.AsyncRead(read_queue.pop());
        }
    }
}
```





#### 驱动：Driver

接口：(均不用加锁)

- AsyncRead
- AsyncWrite
- SetReadCpltCb
- SetWriteCpltCb

#### 硬件：

实际硬件外设

### 示例

```cpp
UartDriver UART1;

StreamDevice main_uart{UART1};

main_uart.conf.baud_rate = 115200;

main_uart.Open(); // 启动 daemon


// 同步读写，不可在中断中调用
// 把指针发给 daemon，等待 daemon 读写完
std::string str = "Hello!\n";
main_uart.Write(str);

uint8_t data[128];
main_uart.Write(data, sizeof(data)); 

main_uart.Read(data, sizeof(data));

// 异步读写

void Callback(const error_code_t error_code){

}

// 拷贝给 daemon，不等待
main_uart.AsyncWrite(str);
main_uart.AsyncWrite(data, sizeof(data));
main_uart.AsyncWrite(str, WriteCallback);
main_uart.WaitForWriting();

main_uart.AsyncRead(data, sizeof(data));
main_uart.AsyncRead(data, sizeof(data), ReadCallback);
main_uart.WaitForReading();
```



